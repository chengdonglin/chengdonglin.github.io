---
title: 回调函数异步变同步
date: 2018-12-29 13:58:46
tags:
	- 导航
    - javascript
categories: javascript
---

### 如何把涉及到回调函数的一个异步过程变成同步过程

#### js中涉及到回调的基本采用了异步的过程,那么如何把一个异步的过程变成同步的过程呢,下面用了一个自执行函数来实现一下:

		(function test(i)){
		   if(i==files.length){<br>      console.log(files);//执行完成后打印最终的值
		      return;
		   }
		   fs.stat("./XXX",function(err,stats){
		           if(stats.isDirectory()){
		                //do somethings<br>                 files.push(XXX);
		           }   
		           test(i+1);//执行完了i=0 再执行i++ 这样就把一个回调异步变成了同步的过程
		    })
		}(0);//一上来 传一个0给参数i 第一次执行


#### 重新封装一层promise

- fs.readdir是一个异步回调的方法,为了解决其变成同步,重新封装一层peomise,然后async/await中使用

		function getfile(dirpath) {
		    return new Promise((resolve,reject)=>{
		        fs.readdir(dirpath,(err,files)=>{
		            res = files.length
		            resolve(res)
		        })
		    })
		}
		async function main(){
		    const result = await getfile("E:\\")
		    console.log(result)//26
		}
		main()

这样子输出result的话就不会是undefined了,而是26

- 一层回调封装一层

		function getfile(dirpath) {
		    return new Promise((resolve,reject)=>{
		        fs.readdir(dirpath,(err,files)=>{
		            res = files.length
		            const Paths = files.map(file =>{
		                return path.resolve(dirpath,file)                    
		            })
		            resolve(Paths)
		        })
		    })
		}
		function describeFile(path){
		    return new Promise((resolve,reject)=>{
		       fs.stat(path,(err,stat)=>{
		        let obj = {}
		        if(err){
		            reject(err)
		        } else {
		            if(stat.isFile()){
		                obj.type = 'file'
		            }
		            if(stat.isDirectory()){
		                obj.type = 'folder'
		            }
		        }
		        resolve(obj)
		    })
		    })
		}
		async function main(){
		    const first = await getfile("E:\\")
		    let three =[]
		    for(let i=0;i<first.length;i++){
		        try {
		            let obj = await describeFile(first[i])
		            three.push(obj)
		        } catch (error) {
		            console.log(error)
		        }
		    }
		    console.log(three)
		}
		main()


通过这种方式完美解决无法函数外部无法访问函数内部的变量